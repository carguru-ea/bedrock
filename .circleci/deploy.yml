version: 2.1

parameters:
  target_env:
    type: string
    default: "INTQA"        # ðŸ‘ˆ default ensures schema passes
  tag_prefix:
    type: string
    default: "INTQA"        # ðŸ‘ˆ required default, overridden dynamically

orbs:
  node: circleci/node@5.0.2


commands:
  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1
      - run:
          name: Install Salesforce CLI and dependencies
          command: |
            if ! sf --version > /dev/null 2>&1; then
              sudo npm install -g @salesforce/cli
            fi
            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"
            sf --version
      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT Key
          command: |
            TARGET_ENV="<< pipeline.parameters.target_env >>"
            echo "ðŸ”‘ Decoding JWT key for environment: $TARGET_ENV"
      
            # Build the variable name dynamically (e.g. JWT_KEY_INTQA)
            VAR_NAME="JWT_KEY_${TARGET_ENV}"
            JWT_KEY_VALUE=${!VAR_NAME}
      
            if [ -z "$JWT_KEY_VALUE" ]; then
              echo "âŒ JWT key not found for environment $TARGET_ENV"
              exit 1
            fi
      
            echo "$JWT_KEY_VALUE" | base64 -d > server.key 2>/dev/null || echo "$JWT_KEY_VALUE" > server.key
            chmod 600 server.key

  # ----------------------------------------------------------
  # Tag-based Deployment
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      test_level:
        type: string
        default: RunLocalTests
      tag_prefix:
        type: string
    steps:
      - run:
          name: Build and Deploy Metadata
          command: |
            echo "ðŸš€ Starting deployment for << parameters.tag_prefix >>..."
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            git fetch --tags
            tags=$(git tag -l '<< parameters.tag_prefix >>-[0-9]*' | sort -V)
            if [ -z "$tags" ]; then
              echo "First deployment, including all files..."
              sf project generate manifest -p force-app
            else
              latest_tag=$(echo "$tags" | tail -n 1)
              echo "Deploying delta from $latest_tag"
              git diff --name-only --relative $latest_tag HEAD | grep '^force-app/' > changed.txt || true
              if [ -s changed.txt ]; then
                sf project generate manifest -p $(cat changed.txt | tr '\n' ',')
              else
                echo "No changes detected, skipping deploy."
                echo "export SKIP_DEPLOY=true" >> $BASH_ENV
              fi
            fi

            source $BASH_ENV
            if [ "${SKIP_DEPLOY:-false}" = "true" ]; then
              echo "âœ… Nothing to deploy."
              exit 0
            fi

            echo "Deploying package..."
            sf project deploy start \
              --manifest package.xml \
              --target-org target \
              --wait 360 \
              --ignore-conflicts \
              --json > deploy-output.json || true

            DEPLOY_ID=$(jq -r '.result.id // empty' deploy-output.json)
            echo "export DEPLOY_ID=$DEPLOY_ID" >> $BASH_ENV
            echo "Captured Deploy ID: $DEPLOY_ID"

  # ----------------------------------------------------------
  # Cancel Active Salesforce Deployment
  # ----------------------------------------------------------
  cancel-deploy:
    parameters:
      target_env:
        type: string
    steps:
      - install-tooling
      - jwt-auth:
          target_env: << parameters.target_env >>
      - run:
          name: Cancel Active Salesforce Deployment
          command: |
            echo "ðŸ§¹ Checking for ongoing deployment..."
            if [ -n "${DEPLOY_ID:-}" ]; then
              echo "Cancelling deployment job $DEPLOY_ID..."
              sf project deploy cancel --job-id "$DEPLOY_ID" --target-org target || true
            else
              echo "No active deployment ID found."
            fi

# -----------------------------------------------------------------
# JOBS
# -----------------------------------------------------------------
jobs:
  deploy:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: << pipeline.parameters.target_env >>
      - deploy-with-tags:
          tag_prefix: << pipeline.parameters.tag_prefix >>
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: apex-test-results

  cancel-deploy-job:
    docker:
      - image: cimg/node:20.10
    steps:
      - cancel-deploy:
          target_env: << pipeline.parameters.target_env >>

# -----------------------------------------------------------------
# WORKFLOW
# -----------------------------------------------------------------
workflows:
  version: 2
  deploy-pipeline:
    jobs:
      - deploy:
          context: sf-<< pipeline.parameters.target_env >>
      - cancel-deploy-job:
          requires:
            - deploy
          filters:
            branches:
              only:
                - BRInt
                - BRStaging
