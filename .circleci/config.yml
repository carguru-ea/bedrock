version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:

  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1
      - run:
          name: Install Salesforce CLI and Java
          command: |
            if ! sf --version > /dev/null 2>&1; then
              sudo npm install -g @salesforce/cli
            fi

            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk

            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

            sf --version

      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default


  # ----------------------------------------------------------
  # Tag-Based Deployment With Delta + Manifest (NO TESTS)
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
    steps:

      # ------------------------------------------------------
      # Identify most recent tag
      # ------------------------------------------------------
      - run:
          name: Find Most Recent Tag
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            git fetch --tags

            currentRef=0
            currentTag=""

            tags=$(git tag -l '<< parameters.tag_prefix >>-[0-9]*' | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                refNum=$(echo $tag | cut -d '-' -f 2)
                if [ "$refNum" -gt "$currentRef" ]; then
                  currentRef=$refNum
                  currentTag=$tag
                fi
              done
              echo "Latest tag: $currentTag"
            else
              echo "No tags found for prefix << parameters.tag_prefix >>"
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV
            echo "export CURRENT_TAG=$currentTag" >> $BASH_ENV
            echo "export TAG_PREFIX=<< parameters.tag_prefix >>" >> $BASH_ENV


      # ------------------------------------------------------
      # Build package.xml (metadata-root aware)
      # ------------------------------------------------------
      - run:
          name: Build Package Manifest
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            echo "üîç Building deployable metadata file list..."

            if [ "$CURRENT_REF" -eq 0 ]; then
              echo "üöÄ First deployment ‚Äî scanning entire force-app for metadata roots"

              find force-app/main/default -type f \
                \( -name "*.cls" \
                -o -name "*.trigger" \
                -o -name "*.page" \
                -o -name "*.component" \
                -o -name "*.cmp" \
                -o -name "*.app" \
                -o -name "*-meta.xml" \
                -o -name "*.js-meta.xml" \
                \) > files.txt || true

            else
              echo "üîÅ Delta deployment from tag: $CURRENT_TAG"

              git diff --name-only --relative $CURRENT_TAG HEAD | grep '^force-app/' > temp_files.txt || true
              > files.txt

              while IFS= read -r file; do
                case "$file" in
                  *.cls|*.trigger|*.page|*.component|*.cmp|*.app|*-meta.xml|*.js-meta.xml)
                    if [ -f "$file" ]; then
                      echo "$file" >> files.txt
                    fi
                    ;;
                esac
              done < temp_files.txt
            fi

            echo "üëâ Final metadata root list:"
            cat files.txt || echo "(none)"

            if [ -s files.txt ]; then
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV

              echo "üì¶ Generated package.xml:"
              cat package.xml
            else
              echo "‚ö†Ô∏è No deployable metadata roots found."
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi


      # ------------------------------------------------------
      # Deploy Metadata (NO TESTS)
      # ------------------------------------------------------
      - run:
          name: Deploy Metadata (NoTestRun)
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            if [ "$CHANGES_FOUND" != "true" ]; then
              echo "‚ö†Ô∏è No delta changes ‚Äî full deploy (NoTestRun)."

              find force-app/main/default -type f \
                \( -name "*.cls" \
                -o -name "*.trigger" \
                -o -name "*.page" \
                -o -name "*.component" \
                -o -name "*.cmp" \
                -o -name "*.app" \
                -o -name "*-meta.xml" \
                -o -name "*.js-meta.xml" \
                \) > files.txt || true

              if [ -s files.txt ]; then
                mapfile -t manifest_paths < files.txt
                sf project generate manifest -p "${manifest_paths[@]}"
              else
                echo "‚ö†Ô∏è No metadata files found. Nothing to deploy."
                echo "export DEPLOYMENT_SUCCESS=false" >> $BASH_ENV
                exit 0
              fi
            fi

            echo "üöÄ Deploying metadata with NoTestRun..."
            sf project deploy start \
              --manifest package.xml \
              --target-org target \
              --test-level NoTestRun \
              --ignore-conflicts \
              --wait 360

            echo "export DEPLOYMENT_SUCCESS=true" >> $BASH_ENV


      # ------------------------------------------------------
      # Tag creation
      # ------------------------------------------------------
      - run:
          name: Create & Push Tag
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            if [ "$DEPLOYMENT_SUCCESS" = "true" ]; then
              NEW_REF=$((CURRENT_REF + 1))
              NEW_TAG="$TAG_PREFIX-$NEW_REF"

              git config user.email "circleci@example.com"
              git config user.name "CircleCI"
              git tag "$NEW_TAG"
              git push origin "$NEW_TAG"
            fi


# ============================================================
# JOBS
# ============================================================
jobs:

  # --------------------- INTQA ------------------------------
  deploy-intqa:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  run-tests-intqa:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - run:
          name: Run Apex Tests (INTQA)
          command: |
            echo "üß™ Running ALL Apex tests in INTQA..."
            sf apex run test --all --target-org target --wait 360

  cancel-intqa:
    docker:
      - image: cimg/node:20.10
    steps:
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - run:
          name: Cancel Deployment (INTQA)
          command: |
            echo "üõë Cancel requested ‚Äî polling for active INTQA deployment..."

            for i in {1..6}; do
              DEPLOY_INFO=$(sf project deploy list --target-org target --json || echo "")
              JOB_ID=$(echo "$DEPLOY_INFO" | jq -r '.result | sort_by(.startDate) | reverse | map(select(.state=="Queued" or .state=="InProgress" or .state=="Pending")) | .[0].id')

              if [ -n "$JOB_ID" ] && [ "$JOB_ID" != "null" ]; then
                echo "üö´ Canceling deployment $JOB_ID in INTQA..."
                sf project deploy cancel --target-org target --job-id "$JOB_ID" || true
                echo "‚úÖ Cancel request sent for $JOB_ID"
                exit 0
              fi

              echo "‚è≥ No active deploy yet‚Ä¶ retrying in 5s ($i/6)"
              sleep 5
            done

            echo "‚ö†Ô∏è No active Salesforce deployment detected in INTQA after polling. Nothing to cancel."
            exit 0


  # --------------------- STAGINGUAT -------------------------
  deploy-staging:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  run-tests-staging:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - run:
          name: Run Apex Tests (STAGINGUAT)
          command: |
            echo "üß™ Running ALL Apex tests in STAGINGUAT..."
            sf apex run test --all --target-org target --wait 360

  cancel-staging:
    docker:
      - image: cimg/node:20.10
    steps:
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - run:
          name: Cancel Deployment (STAGINGUAT)
          command: |
            echo "üõë Cancel requested ‚Äî polling for active STAGINGUAT deployment..."

            for i in {1..6}; do
              DEPLOY_INFO=$(sf project deploy list --target-org target --json || echo "")
              JOB_ID=$(echo "$DEPLOY_INFO" | jq -r '.result | sort_by(.startDate) | reverse | map(select(.state=="Queued" or .state=="InProgress" or .state=="Pending")) | .[0].id')

              if [ -n "$JOB_ID" ] && [ "$JOB_ID" != "null" ]; then
                echo "üö´ Canceling deployment $JOB_ID in STAGINGUAT..."
                sf project deploy cancel --target-org target --job-id "$JOB_ID" || true
                echo "‚úÖ Cancel request sent for $JOB_ID"
                exit 0
              fi

              echo "‚è≥ No active deploy yet‚Ä¶ retrying in 5s ($i/6)"
              sleep 5
            done

            echo "‚ö†Ô∏è No active Salesforce deployment detected in STAGINGUAT after polling. Nothing to cancel."
            exit 0


  # --------------------- PROD -------------------------------
  deploy-main:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  run-tests-main:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - run:
          name: Run Apex Tests (PROD)
          command: |
            echo "üß™ Running ALL Apex tests in PROD..."
            sf apex run test --all --target-org target --wait 360

  cancel-prod:
    docker:
      - image: cimg/node:20.10
    steps:
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - run:
          name: Cancel Deployment (PROD)
          command: |
            echo "üõë Cancel requested ‚Äî polling for active PROD deployment..."

            for i in {1..6}; do
              DEPLOY_INFO=$(sf project deploy list --target-org target --json || echo "")
              JOB_ID=$(echo "$DEPLOY_INFO" | jq -r '.result | sort_by(.startDate) | reverse | map(select(.state=="Queued" or .state=="InProgress" or .state=="Pending")) | .[0].id')

              if [ -n "$JOB_ID" ] && [ "$JOB_ID" != "null" ]; then
                echo "üö´ Canceling deployment $JOB_ID in PROD..."
                sf project deploy cancel --target-org target --job-id "$JOB_ID" || true
                echo "‚úÖ Cancel request sent for $JOB_ID"
                exit 0
              fi

              echo "‚è≥ No active deploy yet‚Ä¶ retrying in 5s ($i/6)"
              sleep 5
            done

            echo "‚ö†Ô∏è No active Salesforce deployment detected in PROD after polling. Nothing to cancel."
            exit 0


# ============================================================
# WORKFLOWS (BRANCH ‚Üí ENVIRONMENT)
# ============================================================
workflows:
  version: 2

  build-test-deploy:
    jobs:

      # ----------------- INTQA (BRInt) ----------------------
      - deploy-intqa:
          context: sf-intqa
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      - run-tests-intqa:
          context: sf-intqa
          requires:
            - deploy-intqa
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      - cancel-intqa:
          context: sf-intqa
          requires:
            - deploy-intqa: canceled
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      # ----------------- STAGING (BRStaging) ----------------
      - deploy-staging:
          context: sf-staging
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      - run-tests-staging:
          context: sf-staging
          requires:
            - deploy-staging
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      - cancel-staging:
          context: sf-staging
          requires:
            - deploy-staging: canceled
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      # ----------------- PROD (main) ------------------------
      - deploy-main:
          context: sf-prod
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/

      - run-tests-main:
          context: sf-prod
          requires:
            - deploy-main
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/

      - cancel-prod:
          context: sf-prod
          requires:
            - deploy-main: canceled
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
