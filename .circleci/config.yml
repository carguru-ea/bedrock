version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:
  install-tooling:
    steps:
  # --------------------------------------------------------
  # Tooling
  # --------------------------------------------------------
      - node/install:
          node-version: "20"

      - run:
          name: Install SF CLI
          command: |
            npm install -g @salesforce/cli
            sf --version

# ============================================================
# JOBS PER ORG
# ============================================================
jobs:

  deploy-intqa:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  deploy-staging:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  deploy-main:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

# ============================================================
# WORKFLOWS (BRANCH â†’ ENVIRONMENT)
# ============================================================
workflows:
  version: 2

  build-test-deploy:
    jobs:

      - deploy-intqa:
          context: sf-intqa
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      - deploy-staging:
          context: sf-staging
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      - deploy-main:
          context: sf-prod
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
