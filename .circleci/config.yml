version: 2.1
setup: true

orbs:
  continuation: circleci/continuation@1.0.0

workflows:
  setup:
    jobs:
      - setup-pipeline

jobs:
  setup-pipeline:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Determine environment and config
          command: |
            echo "üîç Determining which configuration to load for branch: $CIRCLE_BRANCH"

            if [[ "$CIRCLE_BRANCH" == "BRInt" ]]; then
              echo '{ "config_path": ".circleci/deploy.yml", "parameters": { "target_env": "INTQA", "tag_prefix": "INTQA" } }' > continuation.json
            elif [[ "$CIRCLE_BRANCH" == "BRStaging" ]]; then
              echo '{ "config_path": ".circleci/deploy.yml", "parameters": { "target_env": "STAGINGUAT", "tag_prefix": "STAGING" } }' > continuation.json
            else
              echo "‚ùå Unsupported branch: $CIRCLE_BRANCH"
              exit 1
            fi

      - continuation/continue:
          configuration_path: ".circleci/deploy.yml"
          parameters: "{\"target_env\": \"$(jq -r '.parameters.target_env' continuation.json)\", \"tag_prefix\": \"$(jq -r '.parameters.tag_prefix' continuation.json)\"}"
