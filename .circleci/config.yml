version: 2.1

orbs:
  node: circleci/node@5.0.2

# =============================================================
# JOB: INTQA DELTA DEPLOYMENT
# =============================================================
jobs:
  intqa-delta-deploy:
    docker:
      - image: cimg/base:stable

    environment:
      BRANCH_TO_CHECKOUT: BRInt
      TAG_PREFIX: "INTQA-"

    steps:
      # ------------------------------
      # Checkout (same as GitHub Actions)
      # ------------------------------
      - checkout:
          path: Bedrock

      # ------------------------------
      # Write SF Auth Token
      # ------------------------------
      - run:
          name: Write Token to File
          command: echo "$SFDX_INTQA_AUTH_URL" > token.txt

      # ------------------------------
      # Setup Node
      # ------------------------------
      - node/install:
          node-version: "20"

      - run:
          name: Install NPM latest
          command: npm install -g latest

      # ------------------------------
      # Install Salesforce CLI
      # ------------------------------
      - run:
          name: Install Salesforce CLI
          command: npm install -g @salesforce/cli

      - run:
          name: Update Salesforce CLI
          command: npm update -g @salesforce/cli

      # ------------------------------
      # Authenticate
      # ------------------------------
      - run:
          name: Auth with DevHub
          command: sf auth sfdxurl store -f token.txt -a targetOrg -d

      # ------------------------------
      # Find Most Recent Tag
      # ------------------------------
      - run:
          name: Find Most Recent Tag
          command: |
            cd Bedrock
            git fetch --tags
            
            currentRef=0
            tags=$(git tag -l "${TAG_PREFIX}[0-9]*" | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                refNum=$(echo $tag | cut -d '-' -f 2)
                if test $refNum -gt $currentRef; then
                  currentRef=$refNum
                  currentTag=$tag
                fi
              done
            else
              echo "No Tags Found…"
              currentRef=0
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV

      # ------------------------------
      # Build Package Manifest (Delta)
      # ------------------------------
      - run:
          name: Build Manifest for Delta Deploy
          command: |
            source $BASH_ENV
            cd Bedrock/Bedrock

            git diff --diff-filter=ACMR --name-only "${TAG_PREFIX}${CURRENT_REF}" HEAD \
              | cut -b 9- | grep '^force-app/' > files.txt || true

            if [ -s files.txt ]; then
              echo "Changes found:"
              cat files.txt
              sf project generate manifest -p $(cat files.txt)
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "No changes to deploy."
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi

      # ------------------------------
      # Deploy to INTQA
      # ------------------------------
      - run:
          name: Deploy Delta to INTQA
          command: |
            source $BASH_ENV
            if [ "$CHANGES_FOUND" = "true" ]; then
              cd Bedrock/Bedrock
              if test -f package.xml; then
                sf project deploy start -w 360 -x package.xml -l RunLocalTests -o targetOrg 
              else
                echo "No Package Found!"
                exit 1
              fi
            else
              echo "Skipping deploy — no changes found."
            fi

      # ------------------------------
      # Create New Tag
      # ------------------------------
      - run:
          name: Create & Push New Tag
          command: |
            source $BASH_ENV
            if [ "$CHANGES_FOUND" = "true" ]; then
              cd Bedrock
              newTag="${TAG_PREFIX}$((CURRENT_REF + 1))"
              git tag "$newTag"
              git push origin "$newTag"
            else
              echo "Skipping tag — no changes."
            fi

      # ------------------------------
      # Notifications
      # ------------------------------
      - run:
          name: Deployment Success Message
          when: on_success
          command: echo "Successful Deployment!"

      - run:
          name: Deployment Failure Message
          when: on_fail
          command: echo "Deployment Failed! :("


# =============================================================
# WORKFLOW: INTQA Delta Deployment (manual trigger only)
# =============================================================
workflows:
  intqa-scheduled-deploy:
    jobs:
      - intqa-delta-deploy
