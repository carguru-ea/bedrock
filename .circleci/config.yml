version: 2.1

orbs:
  node: circleci/node@5.0.2
  slack: circleci/slack@4.12.5

# ============================================================
# PIPELINE PARAMETERS (manual triggers)
# - env_target controls WHICH env's manual workflow runs
# - action_type controls deploy vs validate
# Default env_target=none ensures NO manual workflows run on PR merges/pushes.
# ============================================================
parameters:
  env_target:
    type: enum
    enum:
      - none
      - intqa
      - staging
      - prod
    default: none

  action_type:
    type: enum
    enum:
      - validate
      - deploy
    default: validate

# ============================================================
# COMMANDS
# ============================================================
commands:

  install-tooling:
    steps:
      - node/install:
          node-version: "20"
      - run:
          name: Install SF CLI
          command: |
            npm install -g @salesforce/cli
            sf --version

  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null \
              || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  # ----------------------------------------------------------
  # DEPLOY/VALIDATE WITH TAGS + CANCEL ACTIVE DEPLOYS
  # operation: deploy | validate
  # create_tags: true|false (tags only created on operation=deploy)
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
      operation:
        type: enum
        enum: [deploy, validate]
        default: deploy
      create_tags:
        type: boolean
        default: true
    steps:

      - run:
          name: Cancel Existing Deploys (Safe Mode)
          command: |
            echo "üîç Checking for active deployments by 'CircleCI User'"

            ACTIVE_DEPLOYS=$(sf data query --use-tooling-api --query \
            "SELECT Id, Status, CreatedDate, NumberComponentsDeployed, NumberComponentsTotal
             FROM DeployRequest
             WHERE Status IN ('Pending','PendingValidation','InProgress')
             AND CreatedBy.Name = 'CircleCI API'
             ORDER BY CreatedDate DESC" --json)

            echo "$ACTIVE_DEPLOYS" | jq .
            DEPLOY_IDS=$(echo "$ACTIVE_DEPLOYS" | jq -r '.result.records[].Id')

            if [ -z "$DEPLOY_IDS" ] || [ "$DEPLOY_IDS" = "null" ]; then
              echo "‚úÖ No active deployments found."
            else
              echo "‚ö†Ô∏è Deployments found ‚Äî attempting cancel..."
              for deployId in $DEPLOY_IDS; do
                echo "‚õî Canceling deployment: $deployId"
                CANCEL_OUTPUT=$(sf project deploy cancel --job-id "$deployId" 2>&1) || true
                echo "$CANCEL_OUTPUT"
                if echo "$CANCEL_OUTPUT" | grep -qi "already completed"; then
                  echo "‚ÑπÔ∏è Deployment $deployId already completed ‚Äî skipping."
                elif echo "$CANCEL_OUTPUT" | grep -qi "CannotCancelDeployError"; then
                  echo "‚ö†Ô∏è Could not cancel deployment $deployId ‚Äî ignoring."
                else
                  echo "‚úîÔ∏è Cancel command processed for $deployId"
                fi
              done
              echo "‚úîÔ∏è Safe cancel complete ‚Äî continuing pipeline."
            fi
            true

      - run:
          name: Find Most Recent Tag
          command: |
            TAG_PREFIX="<< parameters.tag_prefix >>"
            echo "Using Tag Prefix: $TAG_PREFIX"
            git fetch --tags

            currentRef=0
            tags=$(git tag -l "${TAG_PREFIX}[0-9]*" | sort -V)

            if [ -n "$tags" ]; then
              echo "üîç Tags found:"
              echo "$tags"
              for tag in $tags; do
                refNum=$(echo "$tag" | sed -E "s/${TAG_PREFIX}([0-9]+)/\1/")
                if [ "$refNum" -gt "$currentRef" ]; then
                  currentRef=$refNum
                fi
              done
              echo "Latest tag: ${TAG_PREFIX}${currentRef}"
            else
              echo "üîç No tags found ‚Äî FIRST RUN"
              currentRef=0
              echo "export FIRST_RUN=true" >> $BASH_ENV
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV

      - run:
          name: Build Manifest
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            echo "Comparing HEAD to tag: ${TAG_PREFIX}${CURRENT_REF}"

            git diff --diff-filter=ACMR --name-only "${TAG_PREFIX}${CURRENT_REF}" HEAD \
              | grep 'force-app/' \
              | sed -E 's#.*(force-app/.*)#\1#' \
              > files.txt || true

            if [ -s files.txt ]; then
              echo "Changes detected:"
              cat files.txt
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "No delta ‚Äî full deploy required"
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi

      - run:
          name: Deploy / Validate Metadata
          command: |
            source $BASH_ENV

            OPERATION="<< parameters.operation >>"

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            echo "OPERATION=$OPERATION"
            echo "FIRST_RUN=$FIRST_RUN"
            echo "CHANGES_FOUND=$CHANGES_FOUND"

            if [ "$CHANGES_FOUND" != "true" ]; then
              sf project generate manifest --source-dir force-app > /dev/null
            fi

            if [ "$OPERATION" = "validate" ]; then
              echo "üß™ VALIDATION (dry run) starting..."
              sf project deploy validate \
                --manifest package.xml \
                --target-org target \
                --test-level RunLocalTests \
                --wait 360
            else
              echo "üöÄ DEPLOY starting..."
              sf project deploy start \
                --manifest package.xml \
                --target-org target \
                --test-level RunLocalTests \
                --wait 360
            fi

      - run:
          name: Create & Push Tag
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"
            CREATE_TAGS="<< parameters.create_tags >>"
            OPERATION="<< parameters.operation >>"

            if [ "$OPERATION" = "validate" ]; then
              echo "Validation run ‚Äî no tag creation."
              exit 0
            fi

            if [ "$CREATE_TAGS" != "true" ]; then
              echo "Tag creation disabled for this job (create_tags=false). Skipping."
              exit 0
            fi

            if [ "$CHANGES_FOUND" = "true" ] || [ "$FIRST_RUN" = "true" ]; then
              PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
              cd "$PROJECT_DIR"

              if [ "$FIRST_RUN" = "true" ]; then
                newTag="${TAG_PREFIX}1"
              else
                newTag="${TAG_PREFIX}$((CURRENT_REF + 1))"
              fi

              git config user.email "circleci@cargurus.com"
              git config user.name "CircleCI"

              git tag "$newTag"
              git push origin "$newTag"
              echo "‚úîÔ∏è Created tag: $newTag"
            else
              echo "No changes ‚Äî skipping tag creation."
            fi

# ============================================================
# JOBS
# ============================================================
jobs:

  # ---------------- INTQA ----------------
  build-deploy-intqa:
    parameters:
      tag_prefix:
        type: string
      operation:
        type: enum
        enum: [deploy, validate]
        default: deploy
      create_tags:
        type: boolean
        default: true
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>
          operation: << parameters.operation >>
          create_tags: << parameters.create_tags >>

      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_fail_1

      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_success_1

  # ---------------- STAGING ----------------
  deploy-staging:
    parameters:
      tag_prefix:
        type: string
      operation:
        type: enum
        enum: [deploy, validate]
        default: deploy
      create_tags:
        type: boolean
        default: true
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>
          operation: << parameters.operation >>
          create_tags: << parameters.create_tags >>

      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_fail_1

      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_success_1

  # ---------------- MAIN (PROD) FULL DEPLOY ----------------
  main-deploy:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD

      - run:
          name: Full Manifest (main)
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            sf project generate manifest --source-dir force-app > /dev/null

      - run:
          name: Deploy (main - full sync)
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            sf project deploy start \
              --manifest package.xml \
              --target-org target \
              --test-level RunLocalTests \
              --wait 360

      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_fail_1

      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_success_1

  # ---------------- MAIN (PROD) VALIDATION ONLY ----------------
  main-validate:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD

      - run:
          name: Full Manifest (main validation)
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            sf project generate manifest --source-dir force-app > /dev/null

      - run:
          name: Validate Only (main - dry run)
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            sf project deploy validate \
              --manifest package.xml \
              --target-org target \
              --test-level RunLocalTests \
              --wait 360

      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_fail_1

      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          template: basic_success_1

# ============================================================
# WORKFLOWS
# ============================================================
workflows:
  version: 2

  # ----------------------------------------------------------
  # AUTO: PR merge to BRInt / BRStaging triggers deploy + tags
  # ----------------------------------------------------------
  build-test-deploy:
    jobs:
      - build-deploy-intqa:
          context: sf-intqa
          tag_prefix: "RAVIDEV-"
          operation: deploy
          create_tags: true
          filters:
            branches:
              only: BRInt

      - deploy-staging:
          context: sf-staging
          tag_prefix: "STAGINGUAT-"
          operation: deploy
          create_tags: true
          filters:
            branches:
              only: BRStaging

  # ----------------------------------------------------------
  # MANUAL: INTQA (runs ONLY when env_target=intqa)
  # Use action_type dropdown to choose validate/deploy
  # ----------------------------------------------------------
  manual-intqa:
    when:
      equal: [ intqa, << pipeline.parameters.env_target >> ]
    jobs:
      - build-deploy-intqa:
          context: sf-intqa
          tag_prefix: "RAVIDEV-"
          operation: << pipeline.parameters.action_type >>
          # tags only on deploy; validate will skip anyway
          create_tags: true
          filters:
            branches:
              only: BRInt

  # ----------------------------------------------------------
  # MANUAL: STAGING (runs ONLY when env_target=staging)
  # ----------------------------------------------------------
  manual-staging:
    when:
      equal: [ staging, << pipeline.parameters.env_target >> ]
    jobs:
      - deploy-staging:
          context: sf-staging
          tag_prefix: "STAGINGUAT-"
          operation: << pipeline.parameters.action_type >>
          create_tags: true
          filters:
            branches:
              only: BRStaging

  # ----------------------------------------------------------
  # MANUAL: PROD (runs ONLY when env_target=prod)
  # ----------------------------------------------------------
  manual-prod-deploy:
    when:
      and:
        - equal: [ prod, << pipeline.parameters.env_target >> ]
        - equal: [ deploy, << pipeline.parameters.action_type >> ]
    jobs:
      - main-deploy:
          context: sf-prod
          filters:
            branches:
              only: main

  manual-prod-validate:
    when:
      and:
        - equal: [ prod, << pipeline.parameters.env_target >> ]
        - equal: [ validate, << pipeline.parameters.action_type >> ]
    jobs:
      - main-validate:
          context: sf-prod
          filters:
            branches:
              only: main
