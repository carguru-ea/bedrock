version: 2.1

orbs:
  node: circleci/node@5.0.2

commands:
  # ----------------------------------------------------------
  # Install Salesforce CLI, Java, and cache them for speeds 
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1
      - run:
          name: Install Salesforce CLI and dependencies (cached)
          command: |
            # Install Salesforce CLI
            if ! sf --version > /dev/null 2>&1; then
              echo "Installing Salesforce CLI..."
              sudo npm install -g @salesforce/cli
            fi

            # Install Java
            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk

            # Ensure PATH includes npm global bin
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

            # Verify installations
            echo "Verifying installs..."
            which sf || echo "‚ö†Ô∏è sf not found"
            sf --version
      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key
      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  # ----------------------------------------------------------
  # Tag-based Delta Deployment (replacing sgd logic)
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      test_level:
        type: string
        default: RunLocalTests
      tag_prefix:
        type: string
        description: "Tag prefix for the environment (e.g., INTQA, STAGING)"
    steps:
      - run:
          name: Find Most Recent Tag
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            echo "Using Salesforce DX project at $PROJECT_DIR"
            
            # Fetch all tags
            git fetch --tags
            currentRef=0
            currentTag=""

            # Store tags in a variable and find the latest one
            tags=$(git tag -l '<< parameters.tag_prefix >>-[0-9]*' | sort -V)
            
            if [ -n "$tags" ]; then
              echo "Found existing << parameters.tag_prefix >> tags:"
              echo "$tags"
              for tag in $tags; do
                refNum=$(echo $tag | cut -d '-' -f 2)
                if [ "$refNum" -gt "$currentRef" ]; then
                    currentRef=$refNum
                    currentTag=$tag
                fi
              done
              echo "Latest tag found: $currentTag (ref: $currentRef)"
            else
              echo "No << parameters.tag_prefix >> tags found. This will be the first deployment."
              currentRef=0
            fi
            
            # Export for next steps
            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV
            echo "export CURRENT_TAG=$currentTag" >> $BASH_ENV
            echo "export TAG_PREFIX=<< parameters.tag_prefix >>" >> $BASH_ENV

      - run:
          name: Build Package Manifest from Tag Delta (With File Validation)
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            echo "Working from Salesforce project directory: $(pwd)"
            
            if [ "$CURRENT_REF" -eq 0 ]; then
              # First deployment
              echo "First deployment detected. Including all metadata files."
              find force-app -type f \( -name "*.xml" -o -name "*.cls" -o -name "*.trigger" -o -name "*.page" -o -name "*.component" -o -name "*.js" -o -name "*.css" \) > files.txt || true
            else
              # Delta deployment - get changed files from git but adjust the working directory context
              echo "Delta deployment from tag: $CURRENT_TAG"
              
              # Use git diff with --relative flag to get paths relative to current directory
              git diff --name-only --relative $CURRENT_TAG HEAD | grep '^force-app/' | grep -E '\.(cls|trigger|xml|page|component|js|css)$' > temp_files.txt || true
              
              echo "Changed files found from git diff:"
              cat temp_files.txt || echo "No files found"
              
              # Filter out files that don't actually exist
              > files.txt  # Clear the file
              while IFS= read -r file; do
                if [ -f "$file" ]; then
                  echo "$file" >> files.txt
                  echo "‚úÖ Including: $file"
                else
                  echo "‚ùå Skipping (not found): $file"
                fi
              done < temp_files.txt
              
              echo "Final filtered files (only existing ones):"
              cat files.txt || echo "No existing files found"
            fi
            
            # Check if we have files to deploy
            if [ -s files.txt ]; then
                line_count=$(wc -l < files.txt)
                echo "Files to include in manifest:"
                echo "Total existing files found: $line_count"
                
                if [ $line_count -gt 0 ]; then
                    # Show first 10 files for logging
                    head -10 files.txt
                    if [ $line_count -gt 10 ]; then
                        echo "... and $(($line_count - 10)) more files"
                    fi

                    # Build an array from files.txt so filenames with spaces are preserved
                    mapfile -t manifest_paths < files.txt
                    echo "Generating package manifest..."
                    sf project generate manifest -p "${manifest_paths[@]}"

                    if [ -f "package.xml" ]; then
                      echo "‚úÖ Package manifest generated successfully"
                      echo "export CHANGES_FOUND=true" >> $BASH_ENV
                      
                      echo "Package.xml contents:"
                      cat package.xml
                    else
                      echo "‚ùå Failed to generate package.xml"
                      echo "export CHANGES_FOUND=false" >> $BASH_ENV
                    fi
                else 
                    echo "üîç No existing files to deploy to << parameters.tag_prefix >>."
                    echo "export CHANGES_FOUND=false" >> $BASH_ENV
                fi
            else 
                echo "üîç No files to deploy to << parameters.tag_prefix >>."
                echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi

      - run:
          name: Deploy Metadata (only if changes exist)
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            
            if [ "$CHANGES_FOUND" = "true" ]; then
              if [ -f "package.xml" ]; then
                echo "üöÄ Deploying metadata changes..."
                sf project deploy start \
                  --manifest package.xml \
                  --target-org target \
                  --test-level << parameters.test_level >> \
                  --wait 360 \
                  --ignore-conflicts
                
                echo "‚úÖ Deployment completed successfully"
                echo "export DEPLOYMENT_SUCCESS=true" >> $BASH_ENV
              else 
                echo "‚ùå No package.xml found!"
                exit 1
              fi
            else
              echo "‚úÖ No changes to deploy. Skipping deployment step."
              echo "export DEPLOYMENT_SUCCESS=false" >> $BASH_ENV
            fi

      - run:
          name: Set New Tag (only after successful deployment)
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            
            if [ "$CHANGES_FOUND" = "true" ] && [ "$DEPLOYMENT_SUCCESS" = "true" ]; then
              NEW_REF=$((CURRENT_REF + 1))
              NEW_TAG="$TAG_PREFIX-$NEW_REF"
              
              echo "üè∑Ô∏è Creating new tag: $NEW_TAG"
              git config user.email "circleci@example.com"
              git config user.name "CircleCI"
              git tag "$NEW_TAG"
              git push origin "$NEW_TAG"
              
              echo "‚úÖ Successfully created and pushed tag: $NEW_TAG"
            else
              echo "‚úÖ No deployment occurred or deployment failed, no new tag needed."
            fi

# -----------------------------------------------------------------
# JOBS PER ENVIRONMENT
# -----------------------------------------------------------------
jobs:
  deploy-intqa:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          test_level: RunLocalTests
          tag_prefix: INTQA
      - run:
          name: Move test results to root (if exist)
          command: |
            mkdir -p test-results
            find . -type d -name "test-results" ! -path "./test-results" -exec cp -r {}/* test-results/ \; || true
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: apex-test-results

  deploy-staging:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          test_level: RunLocalTests
          tag_prefix: STAGING
      - run:
          name: Move test results to root (if exist)
          command: |
            mkdir -p test-results
            find . -type d -name "test-results" ! -path "./test-results" -exec cp -r {}/* test-results/ \; || true
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: apex-test-results

  deploy-main:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          test_level: RunLocalTests
          tag_prefix: << pipeline.git.branch >>
      - run:
          name: Move test results to root (if exist)
          command: |
            mkdir -p test-results
            find . -type d -name "test-results" ! -path "./test-results" -exec cp -r {}/* test-results/ \; || true
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: apex-test-results


# -----------------------------------------------------------------
# WORKFLOWS ‚Äì map branches to orgs
# -----------------------------------------------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:

      # Integration QA branch ‚Üí IntQA org
      - deploy-intqa:
          context: sf-intqa
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRInt

      # Staging branch ‚Üí Staging/UAT org
      - deploy-staging:
          context: sf-staging
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRStaging

      # Main branch ‚Üí Production tag prefix
      - deploy-main:
          context: sf-prod
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: main
