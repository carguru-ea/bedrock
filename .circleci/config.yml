version: 2.1

orbs:
  node: circleci/node@5.0.2
  slack: circleci/slack@4.12.5

# ============================================================
# COMMANDS
# ============================================================
commands:

  # --------------------------------------------------------
  # Install Tooling
  # --------------------------------------------------------
  install-tooling:
    steps:
      - node/install:
          node-version: "20"

      - run:
          name: Install SF CLI
          command: |
            npm install -g @salesforce/cli
            sf --version


  # --------------------------------------------------------
  # JWT Authentication
  # --------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for ${TARGET_ENV}
          command: |
            echo "${JWT_KEY_${TARGET_ENV}}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_${TARGET_ENV}}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce (${TARGET_ENV})
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_${TARGET_ENV}}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_${TARGET_ENV}}" \
              --instance-url "${SF_INSTANCEURL_${TARGET_ENV}}" \
              --alias target \
              --set-default


  # --------------------------------------------------------
  # DEPLOY WITH TAGS (NO << >> INSIDE)
  # --------------------------------------------------------
  deploy-with-tags:
    steps:

      # Identify most recent tag
      - run:
          name: Find Most Recent Tag
          command: |
            TAG_PREFIX="${TAG_PREFIX}"
            echo "Using Tag Prefix: $TAG_PREFIX"

            git fetch --tags
            currentRef=0

            tags=$(git tag -l "${TAG_PREFIX}[0-9]*" | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                num=$(echo "$tag" | sed -E "s/${TAG_PREFIX}//")
                if [ "$num" -gt "$currentRef" ]; then currentRef=$num; fi
              done
              echo "Latest Tag Found: ${TAG_PREFIX}${currentRef}"
            else
              echo "No tags found for prefix: $TAG_PREFIX"
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV


      # Build Manifest
      - run:
          name: Build Manifest
          command: |
            source $BASH_ENV
            TAG_PREFIX="${TAG_PREFIX}"

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            echo "Comparing HEAD to tag: ${TAG_PREFIX}${CURRENT_REF}"

            git diff --diff-filter=ACMR --name-only "${TAG_PREFIX}${CURRENT_REF}" HEAD \
              | grep 'force-app/' \
              > files.txt || true

            if [ -s files.txt ]; then
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi


      # Deploy
      - run:
          name: Deploy Metadata
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)

            cd "$PROJECT_DIR"

            if [ "$CHANGES_FOUND" != "true" ]; then
              echo "No delta â€” FULL DEPLOY"
              sf project generate manifest --source-dir force-app
            fi

            sf project deploy start \
              --manifest package.xml \
              --target-org target \
              --test-level RunLocalTests \
              --wait 360


      # Create next tag
      - run:
          name: Create & Push New Tag
          command: |
            source $BASH_ENV
            TAG_PREFIX="${TAG_PREFIX}"

            if [ "$CHANGES_FOUND" = "true" ]; then
              PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
              cd "$PROJECT_DIR"

              newTag="${TAG_PREFIX}$((CURRENT_REF + 1))"

              git config user.email "circleci@example.com"
              git config user.name "CircleCI"

              git tag "$newTag"
              git push origin "$newTag"
            else
              echo "Skipping tag â€” full deploy performed."
            fi


  # --------------------------------------------------------
  # SLACK NOTIFICATION (BLOCK MESSAGE)
  # --------------------------------------------------------
  notify-slack:
    steps:

      - run:
          name: Prepare Slack Vars
          command: |
            echo "export PIPELINE_NUMBER=${CIRCLE_PIPELINE_NUMBER}" >> $BASH_ENV
            echo "export BRANCH=${CIRCLE_BRANCH}" >> $BASH_ENV
            echo "export JOB_URL=${CIRCLE_BUILD_URL}" >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Build Slack Block Payload
          command: |
            cat << EOF > slack.json
{
  "channel": "${SLACK_DEFAULT_CHANNEL}",
  "attachments": [
    {
      "color": "#36a64f",
      "blocks": [
        {
          "type": "header",
          "text": { "type": "plain_text", "text": "ðŸš€ Deployment Notification" }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Pipeline:* $PIPELINE_NUMBER\n*Branch:* $BRANCH\n*Link:* $JOB_URL"
          }
        }
      ]
    }
  ]
}
EOF

      - slack/notify:
          event: always
          custom: slack.json


# ============================================================
# JOBS PER ORG (TAG PREFIX -> JOB ENV)
# ============================================================
jobs:

  deploy-intqa:
    docker:
      - image: cimg/node:20.10
    environment:
      TAG_PREFIX: "INTQA-"
      TARGET_ENV: "INTQA"
    steps:
      - checkout
      - install-tooling
      - jwt-auth
      - deploy-with-tags

  deploy-staging:
    docker:
      - image: cimg/node:20.10
    environment:
      TAG_PREFIX: "STAGINGUAT-"
      TARGET_ENV: "STAGINGUAT"
    steps:
      - checkout
      - install-tooling
      - jwt-auth
      - deploy-with-tags

  deploy-main:
    docker:
      - image: cimg/node:20.10
    environment:
      TAG_PREFIX: "PROD-"
      TARGET_ENV: "PROD"
    steps:
      - checkout
      - install-tooling
      - jwt-auth
      - deploy-with-tags


# ============================================================
# WORKFLOWS (Slack once per workflow)
# ============================================================
workflows:
  version: 2

  build-test-deploy:
    jobs:

      - deploy-intqa:
          context: sf-intqa
          filters:
            branches:
              only: BRInt
          post-steps:
            - notify-slack

      - deploy-staging:
          context: sf-staging
          filters:
            branches:
              only: BRStaging
          post-steps:
            - notify-slack

      - deploy-main:
          context: sf-prod
          filters:
            branches:
              only: main
          post-steps:
            - notify-slack
