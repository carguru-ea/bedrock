version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:

  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1
      - run:
          name: Install Salesforce CLI and Java
          command: |
            if ! sf --version > /dev/null 2>&1; then
              sudo npm install -g @salesforce/cli
            fi

            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk
            
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

            sf --version
      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin


  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    steps:
      - run:
          name: Decode JWT Key
          command: |
            echo "$JWT_KEY_INTQA" | base64 -d > server.key 2>/dev/null || echo "$JWT_KEY_INTQA" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to INTQA
          command: |
            sf org login jwt \
              --username "$SF_USERNAME_INTQA" \
              --jwt-key-file server.key \
              --client-id "$SF_CONSUMER_KEY_INTQA" \
              --instance-url "$SF_INSTANCEURL_INTQA" \
              --alias target \
              --set-default


  # ----------------------------------------------------------
  # Delta Deployment with Auto Tagging
  # ----------------------------------------------------------
  deploy-intqa-with-tags:
    steps:

      # ------------------------------------------------------
      # Find Most Recent INTQA Tag
      # ------------------------------------------------------
      - run:
          name: Find Most Recent INTQA Tag
          command: |
            git fetch --tags

            PREFIX="INTQA"
            currentRef=0
            currentTag=""

            tags=$(git tag -l "INTQA-*" | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                number=$(echo "$tag" | awk -F'-' '{print $NF}')
                if [ "$number" -gt "$currentRef" ]; then
                  currentRef=$number
                  currentTag=$tag
                fi
              done
              echo "Latest INTQA tag: $currentTag"
            else
              echo "No INTQA tags found."
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV
            echo "export CURRENT_TAG=$currentTag" >> $BASH_ENV
            echo "export PREFIX=$PREFIX" >> $BASH_ENV


      # ------------------------------------------------------
      # Create Delta Package
      # ------------------------------------------------------
      - run:
          name: Build Manifest (Delta)
          command: |
            source $BASH_ENV

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            if [ "$CURRENT_REF" -eq 0 ]; then
              echo "First deploy. Using all files."
              find force-app -type f > files.txt
            else
              git diff --name-only --relative "$CURRENT_TAG" HEAD | grep '^force-app/' > temp.txt || true

              > files.txt
              while IFS= read -r file; do
                if [ -f "$file" ]; then echo "$file" >> files.txt; fi
              done < temp.txt
            fi

            if [ -s files.txt ]; then
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi


      # ------------------------------------------------------
      # Deploy to INTQA
      # ------------------------------------------------------
      - run:
          name: Deploy Metadata to INTQA
          command: |
            source $BASH_ENV
            if [ "$CHANGES_FOUND" != "true" ]; then
              echo "No changes found. Skipping deploy."
              exit 0
            fi

            echo "ðŸš€ Starting INTQA deploymentâ€¦"
            DEPLOY_OUTPUT=$(sf project deploy start \
              --manifest package.xml \
              --target-org target \
              --test-level NoTestRun \
              --ignore-conflicts \
              --wait 0 \
              --verbose)

            JOB_ID=$(echo "$DEPLOY_OUTPUT" | grep -o "0Af[a-zA-Z0-9]\+")
            echo "Deploy Job: $JOB_ID"

            echo "â³ Polling for completion..."
            while true; do
              STATUS_JSON=$(sf project deploy report --job-id "$JOB_ID" --json)
              STATUS=$(echo "$STATUS_JSON" | jq -r '.result.status')

              echo "Status: $STATUS"
              if [[ "$STATUS" == "Succeeded" || "$STATUS" == "Failed" ]]; then
                break
              fi
              sleep 20
            done

            if [[ "$STATUS" == "Failed" ]]; then
              echo "âŒ Deployment failed"
              exit 1
            fi

            echo "export DEPLOYMENT_SUCCESS=true" >> $BASH_ENV


      # ------------------------------------------------------
      # Tag INTQA after success
      # ------------------------------------------------------
      - run:
          name: Create new INTQA tag
          command: |
            source $BASH_ENV

            if [ "$DEPLOYMENT_SUCCESS" = "true" ]; then

              git fetch --tags

              NEW_REF=$((CURRENT_REF + 1))
              NEW_TAG="$PREFIX-$NEW_REF"

              git config user.email "circleci@local"
              git config user.name "CircleCI Bot"

              git tag "$NEW_TAG"
              git push origin "$NEW_TAG"

              echo "Tag pushed: $NEW_TAG"
            fi

# =====================================================================
# WORKFLOWS
# =====================================================================
workflows:
  version: 2

  # -----------------------------------------
  # INTQA Deploy on BRInt
  # -----------------------------------------
  deploy-intqa-pipeline:
    jobs:
      - deploy-intqa:
          context: sf-intqa
          filters:
            branches:
              only: BRInt

  # -----------------------------------------
  # STAGING Deploy on BRStaging
  # -----------------------------------------
  deploy-staging-pipeline:
    jobs:
      - deploy-staging:
          context: sf-staging
          filters:
            branches:
              only: BRStaging

  # -----------------------------------------
  # PROD Deploy on main
  # -----------------------------------------
  deploy-prod-pipeline:
    jobs:
      - deploy-prod:
          context: sf-prod
          filters:
            branches:
              only: main

  # -----------------------------------------
  # OPTIONAL: Test INTQA pipeline (circleCI-BRInt)
  # -----------------------------------------
  test-brint-deploy:
    jobs:
      - brint-test-pipeline:
          context: sf-intqa
          filters:
            branches:
              only: circleCI-BRInt

  # -----------------------------------------
  # OPTIONAL: Test STAGING pipeline (circleCI-BRStaging)
  # -----------------------------------------
  test-brstaging-deploy:
    jobs:
      - brstaging-test-pipeline:
          context: sf-staging
          filters:
            branches:
              only: circleCI-BRStaging

  # -----------------------------------------
  # OPTIONAL: Test PROD pipeline (circleCI-mainTest)
  # -----------------------------------------
  test-main-deploy:
    jobs:
      - main-test-pipeline:
          context: sf-prod
          filters:
            branches:
              only: circleCI-mainTest
