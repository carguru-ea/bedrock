version: 2.1

orbs:
  node: circleci/node@5.0.2
  slack: circleci/slack@4.12.5

commands:
  install-tooling:
    steps:
      - node/install:
          node-version: "20"
      - run:
          name: Install SF CLI
          command: |
            npm install -g @salesforce/cli
            sf --version

  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
    steps:
      - run:
          name: Cancel Active Deployments
          command: |
            ACTIVE=$(sf data query --use-tooling-api --query "SELECT Id, Status FROM DeployRequest WHERE Status IN ('Pending','PendingValidation','InProgress')" --json)
            IDS=$(echo "$ACTIVE" | jq -r '.result.records[].Id')
            if [ -z "$IDS" ] || [ "$IDS" = "null" ]; then
              echo "No deploys"
            else
              for i in $IDS; do
                sf project deploy cancel --job-id "$i" || true
              done
            fi

      - run:
          name: Find Latest Tag
          command: |
            TAG_PREFIX="<< parameters.tag_prefix >>"
            git fetch --tags
            latest=0
            tags=$(git tag -l "${TAG_PREFIX}[0-9]*" | sort -V)
            if [ -z "$tags" ]; then
              echo "export FIRST_RUN=true" >> $BASH_ENV
            else
              for t in $tags; do
                num=$(echo "$t" | sed -E "s/${TAG_PREFIX}([0-9]+)/\1/")
                [ "$num" -gt "$latest" ] && latest=$num
              done
            fi
            echo "export CURRENT_REF=$latest" >> $BASH_ENV

      - run:
          name: Build Manifest
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"
            PROJECT_DIR=$(find . -name sfdx-project.json -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            git diff --diff-filter=ACMR --name-only "${TAG_PREFIX}${CURRENT_REF}" HEAD | grep "^force-app/" > files.txt || true
            if [ -s files.txt ]; then
              mapfile -t items < files.txt
              sf project generate manifest -p "${items[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi

      - run:
          name: Deploy Metadata
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name sfdx-project.json -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            if [ "$CHANGES_FOUND" = "true" ]; then
              sf project deploy start --manifest package.xml --target-org target --test-level NoTestRun --wait 360
            else
              sf project generate manifest --source-dir force-app
              sf project deploy start --manifest package.xml --target-org target --test-level NoTestRun --wait 360
            fi

      - run:
          name: Tag Release
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"
            if [ "$CHANGES_FOUND" = "true" ] || [ "$FIRST_RUN" = "true" ]; then
              if [ "$FIRST_RUN" = "true" ]; then
                newTag="${TAG_PREFIX}1"
              else
                newTag="${TAG_PREFIX}$((CURRENT_REF + 1))"
              fi
              git config user.email "circleci@example.com"
              git config user.name "CircleCI"
              git tag "$newTag"
              git push origin "$newTag"
              echo "Created tag: $newTag"
            else
              echo "No tag needed"
            fi

jobs:
  detect-changes:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Detect Metadata Changes
          command: |
            git fetch origin $CIRCLE_BRANCH || true
            CHANGED=$(git diff --name-only origin/$CIRCLE_BRANCH HEAD | grep "^force-app/" || true)
            if [ -z "$CHANGED" ]; then
              echo "No changes â€” stopping"
              circleci step halt
            else
              echo "$CHANGED"
            fi

  deploy-intqa:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>
      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL

  deploy-staging:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>
      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL

  deploy-main:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - detect-changes:
          filters:
            branches:
              only:
                - BRInt
                - BRStaging
                - main

      - deploy-intqa:
          requires:
            - detect-changes
          context: sf-intqa
          tag_prefix: "INTQA-"
          filters:
            branches:
              only: BRInt

      - deploy-staging:
          requires:
            - detect-changes
          context: sf-staging
          tag_prefix: "STAGINGUAT-"
          filters:
            branches:
              only: BRStaging

      - deploy-main:
          requires:
            - detect-changes
          context: sf-prod
          tag_prefix: "PROD-"
          filters:
            branches:
              only: main
