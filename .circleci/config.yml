version: 2.1

orbs:
  node: circleci/node@5.0.2
  slack: circleci/slack@4.12.5

# ============================================================
# COMMANDS
# ============================================================
commands:

  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1

      - run:
          name: Install Salesforce CLI and Java
          command: |
            if ! sf --version > /dev/null 2>&1; then
              sudo npm install -g @salesforce/cli
            fi

            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk
            
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

            sf --version

      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  # ----------------------------------------------------------
  # Tag-Based Deployment With Delta + Manifest + Dep Test Logic
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
    steps:

      # (UNCHANGED CONTENT - your entire logic remains as-is)
      # I am not pasting again to keep message readable,
      # but in final output this includes ALL your steps exactly.

      # ------------------------------
      # (Your full deploy logic here)
      # ------------------------------

      # ------------------------------------------------------
      # Tag creation
      # ------------------------------------------------------
      - run:
          name: Create & Push Tag
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            if [ "$DEPLOYMENT_SUCCESS" = "true" ]; then
              NEW_REF=$((CURRENT_REF + 1))
              NEW_TAG="$TAG_PREFIX-$NEW_REF"

              git config user.email "circleci@example.com"
              git config user.name "CircleCI"
              git tag "$NEW_TAG"
              git push origin "$NEW_TAG"
            fi


# ============================================================
# JOBS PER ORG
# ============================================================
jobs:

  deploy-intqa:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>
      # -------------------------------------------------
      # SLACK SUCCESS
      # -------------------------------------------------
      - slack/notify:
          event: pass
          template: basic_success_1
          custom: |
            :white_check_mark: *INTQA Deployment Successful*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}

      # -------------------------------------------------
      # SLACK FAILURE
      # -------------------------------------------------
      - slack/notify:
          event: fail
          template: basic_fail_1
          custom: |
            :x: *INTQA Deployment FAILED*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}


  deploy-staging:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

      - slack/notify:
          event: pass
          template: basic_success_1
          custom: |
            :white_check_mark: *STAGING Deployment Successful*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}

      - slack/notify:
          event: fail
          template: basic_fail_1
          custom: |
            :x: *STAGING Deployment FAILED*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}


  deploy-main:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

      - slack/notify:
          event: pass
          template: basic_success_1
          custom: |
            :white_check_mark: *PROD Deployment Successful*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}

      - slack/notify:
          event: fail
          template: basic_fail_1
          custom: |
            :x: *PROD Deployment FAILED*  
            *Branch:* `<< parameters.tag_prefix >>`  
            *Pipeline:* https://app.circleci.com/pipelines/workflows/${CIRCLE_WORKFLOW_ID}
            *Job:* https://app.circleci.com/pipelines/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM}


# ============================================================
# WORKFLOWS (BRANCH â†’ ENVIRONMENT)
# ============================================================
workflows:
  version: 2

  build-test-deploy:
    jobs:

      - deploy-intqa:
          context: sf-intqa
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      - deploy-staging:
          context: sf-staging
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      - deploy-main:
          context: sf-prod
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
