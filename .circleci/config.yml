      - run:
          name: Build Package Manifest
          command: |
            source $BASH_ENV

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            echo "ðŸ” Building deployable metadata file list..."

            # ------------------------------------------------------
            # NEW: Dynamically detect metadata root from sfdx-project.json
            # ------------------------------------------------------
            SRC_DIR=$(jq -r '.packageDirectories[0].path' sfdx-project.json)
            echo "Detected source directory: $SRC_DIR"

            if [ ! -d "$SRC_DIR" ]; then
              echo "âŒ ERROR: Source directory $SRC_DIR not found."
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
              exit 0
            fi

            # ------------------------------------------------------
            # Full scan (first deployment)
            # ------------------------------------------------------
            if [ "$CURRENT_REF" -eq 0 ]; then
              echo "ðŸš€ First deployment â€” scanning full metadata root: $SRC_DIR"

              find "$SRC_DIR" -type f \
                \( -name "*.cls" \
                -o -name "*.trigger" \
                -o -name "*.page" \
                -o -name "*.component" \
                -o -name "*.cmp" \
                -o -name "*.app" \
                -o -name "*-meta.xml" \
                -o -name "*.js-meta.xml" \
                \) > files.txt || true

            else
              # ------------------------------------------------------
              # Delta scan using git diff
              # ------------------------------------------------------
              echo "ðŸ” Delta deployment from tag: $CURRENT_TAG"

              git diff --name-only --relative "$CURRENT_TAG" HEAD | grep "$SRC_DIR" > temp_files.txt || true

              > files.txt

              while IFS= read -r file; do
                case "$file" in
                  *.cls|*.trigger|*.page|*.component|*.cmp|*.app|*-meta.xml|*.js-meta.xml)
                    echo "$file" >> files.txt
                    ;;
                esac
              done < temp_files.txt
            fi

            echo "ðŸ“„ Final metadata root list:"
            cat files.txt || echo "(empty)"

            # ------------------------------------------------------
            # Build package.xml
            # ------------------------------------------------------
            if [ -s files.txt ]; then
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
              echo "ðŸ“¦ Generated package.xml:"
              cat package.xml
            else
              echo "âš ï¸ No deployable metadata found â€” skipping deploy"
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi
