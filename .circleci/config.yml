version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:

  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1

      - run:
          name: Install Salesforce CLI and Java
          command: |
            echo "ðŸ”§ Installing tooling..."
            if ! sf --version > /dev/null 2>&1; then
              echo "ðŸ“¦ Installing Salesforce CLI..."
              sudo npm install -g @salesforce/cli
            fi

            echo "â˜• Installing Java..."
            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk

            echo "ðŸ§­ Updating PATH..."
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"

            sf --version
            echo "âœ… Tooling installed."

      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin


  # ----------------------------------------------------------
  # JWT Authentication (INTQA)
  # ----------------------------------------------------------
  jwt-auth-intqa:
    steps:
      - run:
          name: Decode JWT Key
          command: |
            echo "ðŸ” Decoding INTQA JWT key..."
            echo "$JWT_KEY_INTQA" | base64 -d > server.key 2>/dev/null || echo "$JWT_KEY_INTQA" > server.key
            chmod 600 server.key
      - run:
          name: Authenticate to INTQA
          command: |
            echo "ðŸ”‘ Authenticating INTQA..."
            sf org login jwt \
              --username "$SF_USERNAME_INTQA" \
              --jwt-key-file server.key \
              --client-id "$SF_CONSUMER_KEY_INTQA" \
              --instance-url "$SF_INSTANCEURL_INTQA" \
              --alias target \
              --set-default
            echo "âœ… Authenticated to INTQA."


  # ----------------------------------------------------------
  # JWT Authentication (STAGING)
  # ----------------------------------------------------------
  jwt-auth-staging:
    steps:
      - run:
          name: Decode JWT Key
          command: |
            echo "ðŸ” Decoding STAGING JWT key..."
            echo "$JWT_KEY_STAGINGUAT" | base64 -d > server.key 2>/dev/null || echo "$JWT_KEY_STAGINGUAT" > server.key
            chmod 600 server.key
      - run:
          name: Authenticate to STAGINGUAT
          command: |
            echo "ðŸ”‘ Authenticating STAGING..."
            sf org login jwt \
              --username "$SF_USERNAME_STAGINGUAT" \
              --jwt-key-file server.key \
              --client-id "$SF_CONSUMER_KEY_STAGINGUAT" \
              --instance-url "$SF_INSTANCEURL_STAGINGUAT" \
              --alias target \
              --set-default
            echo "âœ… Authenticated to STAGING."


  # ----------------------------------------------------------
  # JWT Authentication (PROD)
  # ----------------------------------------------------------
  jwt-auth-prod:
    steps:
      - run:
          name: Decode JWT Key
          command: |
            echo "ðŸ” Decoding PROD JWT key..."
            echo "$JWT_KEY_PROD" | base64 -d > server.key 2>/dev/null || echo "$JWT_KEY_PROD" > server.key
            chmod 600 server.key
      - run:
          name: Authenticate to PROD
          command: |
            echo "ðŸ”‘ Authenticating PROD..."
            sf org login jwt \
              --username "$SF_USERNAME_PROD" \
              --jwt-key-file server.key \
              --client-id "$SF_CONSUMER_KEY_PROD" \
              --instance-url "$SF_INSTANCEURL_PROD" \
              --alias target \
              --set-default
            echo "âœ… Authenticated to PROD."
