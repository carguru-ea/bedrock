version: 2.1

orbs:
  node: circleci/node@5.0.2

commands:
  install-tooling:
    steps:
      - run:
          name: Install Salesforce CLI and dependencies
          command: |
            sudo npm install -g @salesforce/cli
            sf --version
            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk
            java -version

  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key
            chmod 600 server.key
      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url https://login.salesforce.com \
              --alias target \
              --set-default

  deploy:
    parameters:
      test_level:
        type: string
        default: RunLocalTests
    steps:
      - run:
          name: Deploy to Salesforce (<< parameters.test_level >>)
          command: |
            cd bedrock-main
            sf project deploy start \
              --target-org target \
              --test-level "<< parameters.test_level >>" \
              --wait 90
      - run:
          name: Run Apex Tests
          command: |
            cd bedrock-main
            sf apex run test \
              --target-org target \
              --test-level "<< parameters.test_level >>" \
              --code-coverage \
              --result-format junit \
              --wait 60 \
              --output-dir test-results
      - store_artifacts:
          path: bedrock-main/test-results
      - store_test_results:
          path: bedrock-main/test-results

jobs:
  deploy-intqa:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy:
          test_level: RunLocalTests

  deploy-staging:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGING
      - deploy:
          test_level: RunLocalTests

  deploy-prod:
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy:
          test_level: RunLocalTests

workflows:
  version: 2
  build-test-deploy:
    jobs:
      # Integration QA branch → IntQA org
      - deploy-intqa:
          context: sf-intqa
          filters:
            branches:
              only: BRInt

      # Staging branch → Stagindg/UAT org
      - deploy-staging:
          context: sf-staging
          filters:
            branches:
              only: BRStaging

      # Main branch → Pr oduction orgd
      - deploy-prod:
          context: sf-prod
          filters:
            branches:
              only: main
