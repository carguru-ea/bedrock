version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:

  # ----------------------------------------------------------
  # Install Salesforce CLI + Java
  # ----------------------------------------------------------
  install-tooling:
    steps:
      - restore_cache:
          keys:
            - sf-cli-cache-v1

      - run:
          name: Install Salesforce CLI and Java
          command: |
            if ! sf --version > /dev/null 2>&1; then
              sudo npm install -g @salesforce/cli
            fi

            sudo apt-get update && sudo apt-get install -y openjdk-17-jdk
            echo 'export PATH=$(npm bin -g):$PATH' >> "$BASH_ENV"
            source "$BASH_ENV"
            sf --version

      - save_cache:
          key: sf-cli-cache-v1
          paths:
            - ~/.npm
            - /usr/local/lib/node_modules
            - /usr/local/bin

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT Key
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  # ----------------------------------------------------------
  # Full Deployment Logic (Delta, Manifest, Tests, Async Deploy)
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
    steps:

      # ------------------------------------------------------
      # Identify Latest Tag
      # ------------------------------------------------------
      - run:
          name: Find Most Recent Tag
          command: |
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
            git fetch --tags

            currentRef=0
            currentTag=""
            tags=$(git tag -l '<< parameters.tag_prefix >>-[0-9]*' | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                num=$(echo $tag | cut -d '-' -f 2)
                if [ "$num" -gt "$currentRef" ]; then
                  currentRef=$num
                  currentTag=$tag
                fi
              done
              echo "Latest tag: $currentTag"
            else
              echo "No tags found"
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV
            echo "export CURRENT_TAG=$currentTag" >> $BASH_ENV
            echo "export TAG_PREFIX=<< parameters.tag_prefix >>" >> $BASH_ENV


      # ------------------------------------------------------
      # Build package.xml
      # ------------------------------------------------------
      - run:
          name: Build Package Manifest
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            if [ "$CURRENT_REF" = "0" ]; then
              echo "Full scan"
              find force-app/main/default -type f \
                \( -name "*.cls" -o -name "*.trigger" -o -name "*.page" \
                -o -name "*.cmp" -o -name "*.component" -o -name "*.app" \
                -o -name "*.js-meta.xml" -o -name "*-meta.xml" \) > files.txt
            else
              echo "Delta scan"
              git diff --name-only --relative $CURRENT_TAG HEAD | grep '^force-app/' > temp_files.txt || true
              > files.txt
              while read file; do
                case "$file" in
                  *.cls|*.trigger|*.js-meta.xml|*.page|*.component|*.cmp|*.app|*-meta.xml)
                    [ -f "$file" ] && echo "$file" >> files.txt
                esac
              done < temp_files.txt
            fi

            if [ -s files.txt ]; then
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi


      # ------------------------------------------------------
      # Identify Dependent Test Classes
      # ------------------------------------------------------
      - run:
          name: Identify Dependent Test Classes
          command: |
            set -euo pipefail
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            grep -oP '(?<=classes/)[A-Za-z0-9_]+(?=\.cls$)' files.txt | sort -u > changed_classes.txt || true

            if [ ! -s changed_classes.txt ]; then
              echo "export TEST_CLASSES=''" >> $BASH_ENV
              exit 0
            fi

            classList=$(paste -sd "," changed_classes.txt | sed "s/,/','/g")
            classList="'${classList}'"

            sf data query --query "SELECT Id, Name FROM ApexClass WHERE Name IN (${classList})" \
              --use-tooling-api --target-org target --json > classIds.json

            CLASS_IDS=$(jq -r '.result.records[].Id' classIds.json | xargs || true)

            if [ -z "$CLASS_IDS" ]; then
              echo "export TEST_CLASSES=''" >> $BASH_ENV
              exit 0
            fi

            idList=$(echo "$CLASS_IDS" | sed "s/ /','/g")
            idList="'${idList}'"

            sf data query \
              --query "SELECT MetadataComponentName FROM MetadataComponentDependency WHERE RefMetadataComponentId IN (${idList}) AND MetadataComponentType='ApexClass'" \
              --use-tooling-api --target-org target --json > dependentTests.json

            TEST_CLASSES=$(jq -r '.result.records[].MetadataComponentName' dependentTests.json | xargs || true)
            echo "export TEST_CLASSES=\"$TEST_CLASSES\"" >> $BASH_ENV


      # ------------------------------------------------------
      # Start Async Deployment ONLY
      # ------------------------------------------------------
      - run:
          name: Start Async Deployment
          command: |
            source $BASH_ENV
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"

            TEST_ARGS=""
            DEPLOY_TEST_LEVEL="NoTestRun"

            if [ -n "$TEST_CLASSES" ]; then
              DEPLOY_TEST_LEVEL="RunSpecifiedTests"
              for T in $TEST_CLASSES; do TEST_ARGS="$TEST_ARGS --tests $T"; done
            elif [ "$CHANGES_FOUND" = "true" ]; then
              DEPLOY_TEST_LEVEL="RunLocalTests"
            fi

            DEPLOY_ID=$(
              sf project deploy start \
                --manifest package.xml \
                --test-level "$DEPLOY_TEST_LEVEL" \
                $TEST_ARGS \
                --ignore-conflicts \
                --async \
                --json | jq -r '.result.id'
            )

            echo "$DEPLOY_ID" > deploy-info/deploy_id.txt
            echo "$CURRENT_REF" > deploy-info/current_ref.txt

      # Save deploy info
      - persist_to_workspace:
          root: deploy-info
          paths:
            - deploy_id.txt
            - current_ref.txt
            - files.txt
            - changed_classes.txt
            - dependentTests.json
            - classIds.json



# ============================================================
# JOBS
# ============================================================

jobs:

  # ------------------------------------------------------------
  # DEPLOY START JOB
  # ------------------------------------------------------------
  deploy-start:
    parameters:
      target_env:
        type: string
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: << parameters.target_env >>
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>


  # ------------------------------------------------------------
  # DEPLOY MONITOR JOB
  # ------------------------------------------------------------
  deploy-monitor:
    parameters:
      target_env:
        type: string
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - attach_workspace:
          at: deploy-info
      - install-tooling
      - jwt-auth:
          target_env: << parameters.target_env >>
      - run:
          name: Resume Deployment Until Completion
          command: |
            DEPLOY_ID=$(cat deploy-info/deploy_id.txt)
            sf project deploy resume --job-id "$DEPLOY_ID" --wait 360 --json

      - run:
          name: Create Success Tag
          command: |
            CURR_REF=$(cat deploy-info/current_ref.txt)
            NEW_REF=$((CURR_REF + 1))
            NEW_TAG="<< parameters.tag_prefix >>-$NEW_REF"

            git config user.email "circleci@example.com"
            git config user.name "CircleCI"

            git tag "$NEW_TAG"
            git push origin "$NEW_TAG"


  # ------------------------------------------------------------
  # DEPLOY CANCEL JOB
  # ------------------------------------------------------------
  deploy-cancel:
    parameters:
      target_env:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - attach_workspace:
          at: deploy-info
      - install-tooling
      - jwt-auth:
          target_env: << parameters.target_env >>
      - run:
          name: Cancel Salesforce Deployment
          command: |
            if [ ! -f deploy-info/deploy_id.txt ]; then
              echo "No deploy ID found; nothing to cancel."
              exit 0
            fi

            DEPLOY_ID=$(cat deploy-info/deploy_id.txt)
            SHORT_ID=${DEPLOY_ID:0:15}

            sf project deploy cancel --job-id "$SHORT_ID" --target-org target || true
            echo "Cancel command sent."



# ============================================================
# WORKFLOW
# ============================================================
workflows:
  version: 2

  deploy-intqa-pipeline:
    jobs:

      - deploy-start:
          name: deploy-start-intqa
          context: sf-intqa
          target_env: INTQA
          tag_prefix: << pipeline.git.branch >>
          filters:
            branches:
              only: BRInt

      - deploy-monitor:
          name: deploy-monitor-intqa
          context: sf-intqa
          target_env: INTQA
          tag_prefix: << pipeline.git.branch >>
          requires:
            - deploy-start-intqa

      - deploy-cancel:
          name: deploy-cancel-intqa
          context: sf-intqa
          target_env: INTQA
          requires:
            - deploy-start-intqa
          type: approval
