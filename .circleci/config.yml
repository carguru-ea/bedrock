version: 2.1

orbs:
  node: circleci/node@5.0.2

# ============================================================
# COMMANDS
# ============================================================
commands:
  install-tooling:
    steps:
      # --------------------------------------------------------
      # Tooling
      # --------------------------------------------------------
      - node/install:
          node-version: "20"

      - run:
          name: Install SF CLI
          command: |
            npm install -g @salesforce/cli
            sf --version

  # ----------------------------------------------------------
  # JWT Authentication
  # ----------------------------------------------------------
  jwt-auth:
    parameters:
      target_env:
        type: string
    steps:
      - run:
          name: Decode JWT key for << parameters.target_env >>
          command: |
            echo "${JWT_KEY_<< parameters.target_env >>}" | base64 -d > server.key 2>/dev/null || echo "${JWT_KEY_<< parameters.target_env >>}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce (<< parameters.target_env >>)
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_<< parameters.target_env >>}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_<< parameters.target_env >>}" \
              --instance-url "${SF_INSTANCEURL_<< parameters.target_env >>}" \
              --alias target \
              --set-default

  # ----------------------------------------------------------
  # Deploy with Tags
  # ----------------------------------------------------------
  deploy-with-tags:
    parameters:
      tag_prefix:
        type: string
    steps:

      # ------------------------------------------------------
      # Identify most recent tag
      # ------------------------------------------------------
      - run:
          name: Find Most Recent Tag
          command: |
            TAG_PREFIX="<< parameters.tag_prefix >>"
            echo "Using Tag Prefix: $TAG_PREFIX"

            git fetch --tags
            currentRef=0

            tags=$(git tag -l "${TAG_PREFIX}[0-9]*" | sort -V)

            if [ -n "$tags" ]; then
              for tag in $tags; do
                refNum=$(echo $tag | cut -d '-' -f 2)
                if [ "$refNum" -gt "$currentRef" ]; then
                  currentRef=$refNum
                fi
              done
              echo "Latest Tag Found: ${TAG_PREFIX}${currentRef}"
            else
              echo "No tags found for prefix: $TAG_PREFIX"
            fi

            echo "export CURRENT_REF=$currentRef" >> $BASH_ENV

      # --------------------------------------------------------
      # Build Delta Manifest
      # --------------------------------------------------------
      - run:
          name: Build Manifest
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"
      
            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            echo "Detected project directory: $PROJECT_DIR"
            cd "$PROJECT_DIR"
      
            echo "Comparing HEAD to tag: ${TAG_PREFIX}${CURRENT_REF}"
      
            git diff --diff-filter=ACMR --name-only "${TAG_PREFIX}${CURRENT_REF}" HEAD \
              | grep 'force-app/' \
              | sed -E 's#.*(force-app/.*)#\1#' \
              > files.txt || true
      
            if [ -s files.txt ]; then
              echo "Changes detected:"
              cat files.txt
              mapfile -t manifest_paths < files.txt
              sf project generate manifest -p "${manifest_paths[@]}"
              echo "export CHANGES_FOUND=true" >> $BASH_ENV
            else
              echo "No changes detected."
              echo "export CHANGES_FOUND=false" >> $BASH_ENV
            fi

      # --------------------------------------------------------
      # Deploy
      # --------------------------------------------------------
      - run:
          name: Deploy Metadata
          command: |
            source $BASH_ENV
      
            if [ "$CHANGES_FOUND" != "true" ]; then
              echo "âš ï¸ No delta detected â€” performing FULL DEPLOY"
            
              PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
              cd "$PROJECT_DIR"
            
              echo "Generating full package.xml..."
              sf project generate manifest --source-dir force-app > /dev/null
              cat package.xml
            
              FULL_DEPLOY="true"
            else
              FULL_DEPLOY="false"
            fi

            PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
            cd "$PROJECT_DIR"
      
            if [ "$FULL_DEPLOY" = "true" ]; then
              echo "ðŸš€ Running FULL DEPLOY..."
              sf project deploy start \
                --manifest package.xml \
                --target-org target \
                --test-level RunLocalTests \
                --wait 360
            else
              echo "ðŸš€ Running DELTA DEPLOY..."
              sf project deploy start \
                --manifest package.xml \
                --target-org target \
                --test-level RunLocalTests \
                --wait 360
            fi

      # --------------------------------------------------------
      # Create New Tag
      # --------------------------------------------------------
      - run:
          name: Create & Push New Tag
          command: |
            source $BASH_ENV
            TAG_PREFIX="<< parameters.tag_prefix >>"
      
            if [ "$CHANGES_FOUND" = "true" ]; then
              PROJECT_DIR=$(find . -name "sfdx-project.json" -exec dirname {} \; | head -n 1)
              cd "$PROJECT_DIR"
      
              newTag="${TAG_PREFIX}$((CURRENT_REF + 1))"
      
              git config user.email "circleci@example.com"
              git config user.name "CircleCI"
      
              git tag "$newTag"
              git push origin "$newTag"
            else
              echo "No changes â€” skipping tag creation."
            fi


# ============================================================
# JOBS
# ============================================================
jobs:

  deploy-intqa:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: INTQA
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  deploy-staging:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: STAGINGUAT
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  deploy-main:
    parameters:
      tag_prefix:
        type: string
    docker:
      - image: cimg/node:20.10
    steps:
      - checkout
      - install-tooling
      - jwt-auth:
          target_env: PROD
      - deploy-with-tags:
          tag_prefix: << parameters.tag_prefix >>

  # ============================================================
  # SHARED CLEANUP JOB (RUNS ON FAIL OR CANCEL)
  # ============================================================
  cleanup:
    parameters:
      env:
        type: string
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: "Cleanup Handler (on_fail)"
          command: |
            echo "ðŸ›‘ CLEANUP JOB TRIGGERED VIA on_fail"
            echo "Environment: << parameters.env >>"
            echo "Pipeline was FAILED or CANCELED."
            echo "STATUS TEST: on_fail works correctly."


# ============================================================
# WORKFLOWS
# ============================================================
workflows:
  version: 2

  build-test-deploy:
    jobs:

      - deploy-intqa:
          context: sf-intqa
          tag_prefix: "INTQA-"
          filters:
            branches:
              only: BRInt
            tags:
              ignore: /.*/

      - cleanup:
          env: "INTQA"
          requires:
            - deploy-intqa
          when: on_fail
          filters:
            branches:
              only: BRInt


      - deploy-staging:
          context: sf-staging
          tag_prefix: "STAGINGUAT-"
          filters:
            branches:
              only: BRStaging
            tags:
              ignore: /.*/

      - cleanup:
          env: "STAGINGUAT"
          requires:
            - deploy-staging
          when: on_fail
          filters:
            branches:
              only: BRStaging


      - deploy-main:
          context: sf-prod
          tag_prefix: "PROD-"
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/

      - cleanup:
          env: "PROD"
          requires:
            - deploy-main
          when: on_fail
          filters:
            branches:
              only: main
