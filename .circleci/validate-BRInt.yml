version: 2.1

orbs:
  node: circleci/node@5.0.2
  slack: circleci/slack@4.12.5

# ----------------------------------------------------------
# WORKFLOW ‚Äî triggers on PR creation in CircleCI UI settings
# ----------------------------------------------------------
workflows:
  devint-validations:
    jobs:
      - DevInt-Validation

# ----------------------------------------------------------
# JOB: Validate Salesforce metadata (DELTA-ONLY DRY RUN)
# ----------------------------------------------------------
jobs:
  DevInt-Validation:
    docker:
      - image: cimg/base:stable

    steps:
      # Checkout PR branch
      - checkout

      # Install Node + SF CLI
      - node/install:
          node-version: "20"

      - run:
          name: Install Salesforce CLI
          command: |
            npm install -g @salesforce/cli
            sf --version

      # ----------------------------------------------------------
      # JWT AUTH
      # ----------------------------------------------------------
      - run:
          name: Decode JWT key
          command: |
            echo "${JWT_KEY_INTQA}" | base64 -d > server.key 2>/dev/null \
              || echo "${JWT_KEY_INTQA}" > server.key
            chmod 600 server.key

      - run:
          name: Authenticate to Salesforce INTQA
          command: |
            sf org login jwt \
              --username "${SF_USERNAME_INTQA}" \
              --jwt-key-file server.key \
              --client-id "${SF_CONSUMER_KEY_INTQA}" \
              --instance-url "${SF_INSTANCEURL_INTQA}" \
              --alias target \
              --set-default

      # ----------------------------------------------------------
      # DELTA ENGINE (NO GITHUB API)
      # ----------------------------------------------------------
      - run:
          name: Compute Delta Without GitHub API
          command: |
            echo "üîç Extracting PR number from CIRCLE_PULL_REQUEST..."
            echo "CIRCLE_PULL_REQUEST=$CIRCLE_PULL_REQUEST"

            PR_NUMBER=$(echo "$CIRCLE_PULL_REQUEST" | sed 's#.*/pull/##')
            echo "PR number detected: $PR_NUMBER"

            echo "üîÑ Fetching GitHub PR merge ref..."
            git fetch origin +refs/pull/$PR_NUMBER/merge:refs/remotes/origin/pr/$PR_NUMBER

            # Show what merge ref is fetched
            echo "Fetched PR merge ref:"
            git log --oneline -n 1 origin/pr/$PR_NUMBER

            echo "üîç Computing delta diff vs PR merge ref..."
            mkdir -p delta

            git diff --name-only origin/pr/$PR_NUMBER...HEAD \
              | grep "^force-app/" \
              | while read file; do
                  echo "Copying: $file"
                  mkdir -p "delta/$(dirname "$file")"
                  cp "$file" "delta/$file"
                done

            echo "----- DELTA FILES DETECTED -----"
            find delta -type f || true

            if [ -z "$(find delta -type f)" ]; then
              echo "‚ùå No delta detected ‚Äî failing validation."
              exit 1
            fi

            echo "Delta ready ‚úî"

      # ----------------------------------------------------------
      # DRY RUN VALIDATION (DELTA ONLY)
      # ----------------------------------------------------------
      - run:
          name: Validate Metadata (Dry Run ‚Äî Delta Only)
          command: |
            echo "üöÄ Running Salesforce dry-run deploy on delta folder..."
            cd delta

            sf project deploy start \
              --dry-run \
              --wait 360 \
              --target-org target \
              --test-level NoTestRun

      # ----------------------------------------------------------
      # SLACK NOTIFICATIONS
      # ----------------------------------------------------------
      - slack/notify:
          event: pass
          template: basic_success_1

      - slack/notify:
          event: fail
          template: basic_fail_1

